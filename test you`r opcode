--[[
    LVM Opcode Test
    by kernal

]]

local TestSuite = {}
TestSuite.results = {}
TestSuite.total = 0
TestSuite.passed = 0
TestSuite.failed = 0

local function printSeparator(title)
    print("\n" .. string.rep("=", 80))
    print("  " .. title)
    print(string.rep("=", 80))
end

local function testOpcode(name, testFunc, validator)
    TestSuite.total = TestSuite.total + 1
    
    local success, result = pcall(testFunc)
    
    if not success then
        TestSuite.failed = TestSuite.failed + 1
        print(string.format(" [%s] - FAILED: %s", name, tostring(result)))
        print("     OPCODE STRUCTURE NO VALID")
        TestSuite.results[name] = {status = "FAIL", error = result}
        return false
    end
    
    local isValid, validationError = true, nil
    if validator then
        isValid, validationError = pcall(function()
            return validator(result)
        end)
    end
    
    if not isValid or validationError == false then
        TestSuite.failed = TestSuite.failed + 1
        print(string.format(" [%s] - INVALID RESULT", name))
        print("     OPCODE STRUCTURE NO VALID")
        TestSuite.results[name] = {status = "INVALID", result = result}
        return false
    end
    
    TestSuite.passed = TestSuite.passed + 1
    print(string.format(" [%s] - WORK (true)", name))
    TestSuite.results[name] = {status = "PASS", result = result}
    return true
end

-- ============================================================================
-- LOADK, MOVE, LOADBOOL, LOADNIL
-- ============================================================================
printSeparator("BASIC OPCODES: LOADK, MOVE, LOADBOOL, LOADNIL")

testOpcode("LOADK (integer)", function()
    local x = 12345
    return x
end, function(r) return r == 12345 end)

testOpcode("LOADK (float)", function()
    local x = 3.14159
    return x
end, function(r) return math.abs(r - 3.14159) < 0.00001 end)

testOpcode("LOADK (string)", function()
    local x = "test_string"
    return x
end, function(r) return r == "test_string" end)

testOpcode("LOADK (negative)", function()
    local x = -99999
    return x
end, function(r) return r == -99999 end)

testOpcode("MOVE", function()
    local a = 100
    local b = a
    local c = b
    return c
end, function(r) return r == 100 end)

testOpcode("LOADBOOL (true)", function()
    local x = true
    print("   Debug: x type =", type(x), "value =", tostring(x))
    return x
end, function(r) 
    print("   Validator: received type =", type(r), "value =", tostring(r))
    return r == true and type(r) == "boolean"
end)

testOpcode("LOADBOOL (false)", function()
    local x = false
    print("   Debug: x type =", type(x), "value =", tostring(x))
    return x
end, function(r) 
    print("   Validator: received type =", type(r), "value =", tostring(r))
    return r == false and type(r) == "boolean"
end)

testOpcode("LOADBOOL (comparison result)", function()
    local x = (5 > 3)
    print("   Debug: x =", tostring(x))
    return x
end, function(r) return r == true and type(r) == "boolean" end)

testOpcode("LOADBOOL (not result)", function()
    local x = not true
    print("   Debug: x =", tostring(x))
    return x
end, function(r) return r == false and type(r) == "boolean" end)

testOpcode("LOADNIL (single)", function()
    local x = nil
    return x
end, function(r) return r == nil end)

testOpcode("LOADNIL (multiple)", function()
    local a, b, c = nil, nil, nil
    return a == nil and b == nil and c == nil
end, function(r) return r == true end)

-- ============================================================================
-- ADD, SUB, MUL, DIV, MOD, POW
-- ============================================================================
printSeparator("ARITHMETIC OPCODES: ADD, SUB, MUL, DIV, MOD, POW")

testOpcode("ADD", function()
    return 10 + 5
end, function(r) return r == 15 end)

testOpcode("SUB", function()
    return 10 - 5
end, function(r) return r == 5 end)

testOpcode("MUL", function()
    return 10 * 5
end, function(r) return r == 50 end)

testOpcode("DIV", function()
    return 10 / 2
end, function(r) return r == 5 end)

testOpcode("MOD", function()
    return 10 % 3
end, function(r) return r == 1 end)

testOpcode("POW", function()
    return 2 ^ 10
end, function(r) return r == 1024 end)

testOpcode("UNM (unary minus)", function()
    local x = 42
    return -x
end, function(r) return r == -42 end)

testOpcode("Arithmetic chain", function()
    local x = ((10 + 5) * 2 - 3) / 3
    return x
end, function(r) return r == 9 end)

-- ============================================================================
-- NOT, AND, OR
-- ============================================================================
printSeparator("LOGICAL OPCODES: NOT, AND, OR")

testOpcode("NOT (true->false)", function()
    return not true
end, function(r) return r == false end)

testOpcode("NOT (false->true)", function()
    return not false
end, function(r) return r == true end)

testOpcode("AND", function()
    return true and "value"
end, function(r) return r == "value" end)

testOpcode("OR", function()
    return false or "value"
end, function(r) return r == "value" end)

-- ============================================================================
-- EQ, LT, LE
-- ============================================================================
printSeparator("COMPARISON OPCODES: EQ, LT, LE")

testOpcode("EQ (equal)", function()
    return 10 == 10
end, function(r) return r == true end)

testOpcode("EQ (not equal)", function()
    return 10 == 5
end, function(r) return r == false end)

testOpcode("LT (less than)", function()
    return 5 < 10
end, function(r) return r == true end)

testOpcode("LE (less or equal)", function()
    return 10 <= 10
end, function(r) return r == true end)

testOpcode("GT (greater than)", function()
    return 10 > 5
end, function(r) return r == true end)

testOpcode("GE (greater or equal)", function()
    return 10 >= 10
end, function(r) return r == true end)

-- ============================================================================
-- JMP, TEST, TESTSET
-- ============================================================================
printSeparator("CONTROL FLOW: JMP, TEST, TESTSET")

testOpcode("JMP (if-then)", function()
    local x = 0
    if true then
        x = 1
    end
    return x
end, function(r) return r == 1 end)

testOpcode("JMP (if-else)", function()
    local x = 0
    if false then
        x = 1
    else
        x = 2
    end
    return x
end, function(r) return r == 2 end)

testOpcode("JMP (elseif chain)", function()
    local x = 5
    local result
    if x < 3 then
        result = "less"
    elseif x < 7 then
        result = "middle"
    else
        result = "greater"
    end
    return result
end, function(r) return r == "middle" end)

testOpcode("TESTSET", function()
    local a = "value"
    local b = a or "default"
    return b
end, function(r) return r == "value" end)

-- ============================================================================
-- CONCAT, LEN
-- ============================================================================
printSeparator("STRING OPCODES: CONCAT, LEN")

testOpcode("CONCAT (two strings)", function()
    return "hello" .. "world"
end, function(r) return r == "helloworld" end)

testOpcode("CONCAT (multiple)", function()
    return "a" .. "b" .. "c" .. "d"
end, function(r) return r == "abcd" end)

testOpcode("CONCAT (string+number)", function()
    return "value: " .. tostring(42)
end, function(r) return r == "value: 42" end)

testOpcode("LEN (string)", function()
    local s = "test"
    return #s
end, function(r) return r == 4 end)

testOpcode("LEN (empty string)", function()
    return #""
end, function(r) return r == 0 end)

-- ============================================================================
-- NEWTABLE, SETTABLE, GETTABLE, SETLIST
-- ============================================================================
printSeparator("TABLE OPCODES: NEWTABLE, SETTABLE, GETTABLE, SETLIST")

testOpcode("NEWTABLE (empty)", function()
    local t = {}
    return type(t)
end, function(r) return r == "table" end)

testOpcode("SETTABLE", function()
    local t = {}
    t["key"] = "value"
    t[1] = 100
    return t["key"] == "value" and t[1] == 100
end, function(r) return r == true end)

testOpcode("GETTABLE", function()
    local t = {x = 10, y = 20}
    return t.x + t.y
end, function(r) return r == 30 end)

testOpcode("SETLIST (sequential)", function()
    local t = {1, 2, 3, 4, 5}
    return #t == 5 and t[3] == 3
end, function(r) return r == true end)

testOpcode("SETLIST (large >50)", function()
    local t = {}
    for i = 1, 60 do
        t[i] = i
    end
    return t[55] == 55 and t[60] == 60
end, function(r) return r == true end)

testOpcode("LEN (table)", function()
    local t = {1, 2, 3, 4, 5}
    return #t
end, function(r) return r == 5 end)

testOpcode("SELF", function()
    local obj = {
        value = 42,
        getValue = function(self)
            return self.value
        end
    }
    return obj:getValue()
end, function(r) return r == 42 end)

-- ============================================================================
-- FORPREP, FORLOOP, TFORCALL, TFORLOOP
-- ============================================================================
printSeparator("LOOP OPCODES: FORPREP, FORLOOP, TFORCALL, TFORLOOP")

testOpcode("FORLOOP (1 to 10)", function()
    local sum = 0
    for i = 1, 10 do
        sum = sum + i
    end
    return sum
end, function(r) return r == 55 end)

testOpcode("FORLOOP (step)", function()
    local sum = 0
    for i = 0, 10, 2 do
        sum = sum + i
    end
    return sum
end, function(r) return r == 30 end)

testOpcode("FORLOOP (negative step)", function()
    local sum = 0
    for i = 10, 1, -1 do
        sum = sum + i
    end
    return sum
end, function(r) return r == 55 end)

testOpcode("TFORLOOP (pairs)", function()
    local t = {a = 1, b = 2, c = 3}
    local count = 0
    for k, v in pairs(t) do
        count = count + 1
    end
    return count
end, function(r) return r == 3 end)

testOpcode("TFORLOOP (ipairs)", function()
    local t = {10, 20, 30, 40, 50}
    local sum = 0
    for i, v in ipairs(t) do
        sum = sum + v
    end
    return sum
end, function(r) return r == 150 end)

-- ============================================================================
-- CALL, RETURN, CLOSURE, VARARG
-- ============================================================================
printSeparator("FUNCTION OPCODES: CALL, RETURN, CLOSURE, VARARG")

testOpcode("CALL (simple)", function()
    local function add(a, b)
        return a + b
    end
    return add(10, 5)
end, function(r) return r == 15 end)

testOpcode("RETURN (single)", function()
    local function test()
        return 42
    end
    return test()
end, function(r) return r == 42 end)

testOpcode("RETURN (multiple)", function()
    local function test()
        return 1, 2, 3
    end
    local a, b, c = test()
    return a + b + c
end, function(r) return r == 6 end)

testOpcode("CLOSURE", function()
    local function outer(x)
        return function(y)
            return x + y
        end
    end
    local f = outer(10)
    return f(5)
end, function(r) return r == 15 end)

testOpcode("CLOSURE (nested)", function()
    local function outer(x)
        return function(y)
            return function(z)
                return x + y + z
            end
        end
    end
    return outer(1)(2)(3)
end, function(r) return r == 6 end)

testOpcode("VARARG", function()
    local function sum(...)
        local result = 0
        for i, v in ipairs({...}) do
            result = result + v
        end
        return result
    end
    return sum(1, 2, 3, 4, 5)
end, function(r) return r == 15 end)

testOpcode("VARARG (select)", function()
    local function test(...)
        return select("#", ...)
    end
    return test(1, 2, 3, 4, 5)
end, function(r) return r == 5 end)

testOpcode("TAILCALL", function()
    local function factorial(n, acc)
        acc = acc or 1
        if n <= 1 then
            return acc
        end
        return factorial(n - 1, n * acc)
    end
    return factorial(5)
end, function(r) return r == 120 end)

-- ============================================================================
-- GETUPVAL, SETUPVAL, CLOSE
-- ============================================================================
printSeparator("UPVALUE OPCODES: GETUPVAL, SETUPVAL, CLOSE")

testOpcode("GETUPVAL", function()
    local x = 10
    local function test()
        return x
    end
    return test()
end, function(r) return r == 10 end)

testOpcode("SETUPVAL", function()
    local x = 10
    local function test()
        x = 20
    end
    test()
    return x
end, function(r) return r == 20 end)

testOpcode("UPVAL (multiple closures)", function()
    local counter = 0
    local function inc()
        counter = counter + 1
        return counter
    end
    local function get()
        return counter
    end
    inc()
    inc()
    return get()
end, function(r) return r == 2 end)

-- ============================================================================
-- GETMETATABLE, SETMETATABLE
-- ============================================================================
printSeparator("METATABLE OPCODES")

testOpcode("SETMETATABLE", function()
    local mt = {
        __add = function(a, b)
            return a.value + b.value
        end
    }
    local t1 = setmetatable({value = 10}, mt)
    local t2 = setmetatable({value = 20}, mt)
    local result = t1 + t2
    return result
end, function(r) return r == 30 end)

testOpcode("__index metamethod", function()
    local mt = {
        __index = function(t, k)
            return "default"
        end
    }
    local t = setmetatable({}, mt)
    return t.nonexistent
end, function(r) return r == "default" end)

testOpcode("__newindex metamethod", function()
    local storage = {}
    local mt = {
        __newindex = function(t, k, v)
            storage[k] = v * 2
        end
    }
    local t = setmetatable({}, mt)
    t.value = 10
    return storage.value
end, function(r) return r == 20 end)

-- ============================================================================
-- COROUTINE OPS
-- ============================================================================
printSeparator("COROUTINE OPCODES")

testOpcode("COROUTINE (create)", function()
    local co = coroutine.create(function()
        return 42
    end)
    return type(co)
end, function(r) return r == "thread" end)

testOpcode("COROUTINE (resume)", function()
    local co = coroutine.create(function()
        return 42
    end)
    local success, result = coroutine.resume(co)
    return success and result
end, function(r) return r == 42 end)

testOpcode("COROUTINE (yield)", function()
    local co = coroutine.create(function()
        coroutine.yield(1)
        coroutine.yield(2)
        return 3
    end)
    local _, v1 = coroutine.resume(co)
    local _, v2 = coroutine.resume(co)
    local _, v3 = coroutine.resume(co)
    return v1 + v2 + v3
end, function(r) return r == 6 end)

testOpcode("COROUTINE (status)", function()
    local co = coroutine.create(function() end)
    local status1 = coroutine.status(co)
    coroutine.resume(co)
    local status2 = coroutine.status(co)
    return status1 == "suspended" and status2 == "dead"
end, function(r) return r == true end)

-- ============================================================================
-- GETGLOBAL, SETGLOBAL
-- ============================================================================
printSeparator("GLOBAL OPCODES: GETGLOBAL, SETGLOBAL")

testOpcode("SETGLOBAL", function()
    _G.TEST_GLOBAL = 12345
    return _G.TEST_GLOBAL
end, function(r) 
    _G.TEST_GLOBAL = nil
    return r == 12345
end)

testOpcode("GETGLOBAL", function()
    _G.TEST_GLOBAL_2 = "test_value"
    local value = _G.TEST_GLOBAL_2
    _G.TEST_GLOBAL_2 = nil
    return value
end, function(r) return r == "test_value" end)
printSeparator("TEST RESULTS SUMMARY")

print(string.format("\n Total Tests: %d", TestSuite.total))
print(string.format(" Passed: %d (%.1f%%)", TestSuite.passed, (TestSuite.passed/TestSuite.total)*100))
print(string.format(" Failed: %d (%.1f%%)", TestSuite.failed, (TestSuite.failed/TestSuite.total)*100))

if TestSuite.failed > 0 then
    print("\n  WARNING: Some opcodes are not working correctly!")
    print("Failed tests:")
    for name, result in pairs(TestSuite.results) do
        if result.status ~= "PASS" then
            print(string.format("  - %s: %s", name, result.status))
        end
    end
else
    print("\n ALL TESTS PASSED! VM is working correctly.")
end

print("\n" .. string.rep("=", 80))
print("Test completed at: " .. os.date("%Y-%m-%d %H:%M:%S"))
print(string.rep("=", 80))
