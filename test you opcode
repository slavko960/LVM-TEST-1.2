--[[bykernal
                LVM TEST 1.2

]]
wait(1)
print(`------------------------------------------------LOADK MOVE LOADBOOL and more----------------------------------------------------------`)
local function opcode_stress(...)

	-- LOADK / MOVE / LOADBOOL / LOADNIL
	local a = 10
	local b = a
	local c = true
	local d
	local e, f = nil, nil

	-- VARARG
	local var = {...}

	-- ADD / SUB / MUL / DIV / MOD / POW
	local x = a + 5
	x = x - 3
	x = x * 2
	x = x / 4
	x = x % 3
	x = x ^ 2

	-- UNM / NOT
	local y = -x
	local z = not false

	-- LEN / CONCAT
	local s = "op" .. "code"
	local l = #s

	-- EQ / LT / LE / JMP / TEST / TESTSET
	if x == y then
		x = 1
	elseif x < y then
		x = 2
	elseif x <= y then
		x = 3
	else
		x = 4
	end

	-- TABLE OPS: NEWTABLE / SETTABLE / GETTABLE / SETLIST
	local t = {}
	for i = 1, 5 do
		t[i] = i * i
	end

	-- SELF
	local obj = {
		val = 7,
		get = function(self, k)
			return self[k]
		end
	}
	local sv = obj:get("val")

	-- METATABLE
	local mt = {
		__add = function(p, q)
			return p.v + q.v
		end
	}
	local m1 = setmetatable({v = 2}, mt)
	local m2 = setmetatable({v = 3}, mt)
	local m3 = m1 + m2

	-- FORPREP / FORLOOP
	local sum = 0
	for i = 1, 10 do
		sum = sum + i
	end

	-- TFORCALL / TFORLOOP
	for k, v in pairs(t) do
		sum = sum + v
	end

	-- CLOSURE / UPVALUES
	local function outer(n)
		local base = n
		return function(x)
			return base + x
		end
	end
	local cl = outer(10)
	local uv = cl(5)

	-- CALL / MULTRET / RETURN
	local function multi()
		return 1, 2, 3
	end
	local mA, mB, mC = multi()

	-- TAILCALL
	local function tail(n)
		if n == 0 then
			return 0
		end
		return tail(n - 1)
	end
	tail(5)

	print("_COROUTINE")
	local co = coroutine.create(function()
		local r = 0
		for i = 1, 3 do
			r = r + i
			coroutine.yield(r)
		end
		return r
	end)

	local cr = 0
	while coroutine.status(co) ~= "dead" do
		local _, v = coroutine.resume(co)
		if v then cr = cr + v end
	end

	return
		a, b, c, d, e, f,
		x, y, z, s, l,
		sv, m3, sum, uv,
		mA, mB, mC,
		cr,
		#var
end

print(opcode_stress(1, 2, 3, 4, 5))
print("work1")
task.wait(3); print(`----------------------------------------------------------Ljmp and more------------------------------------------------`)
local function fuzz(seed)
	math.randomseed(seed)

	local function rnd()
		return math.random(-50, 50)
	end

	local function gen(n)
		if n == 0 then
			return function(x)
				return x + rnd()
			end
		end

		local f = gen(n - 1)
		return function(x)
			if x % 2 == 0 then
				return f(x - 1)
			else
				return f(x + 1)
			end
		end
	end

	local t = {}
	for i = 1, math.random(1, 20) do
		t[i] = rnd()
	end

	local sum = 0
	for i = 1, #t do
		if t[i] > 0 then
			sum = sum + t[i]
		else
			sum = sum - t[i]
		end
	end

	local f = gen(math.random(1, 6))
	local r = f(sum)

	return r, #t
end

for i = 1, 100 do
	print(fuzz(i))
end
print("work2")
task.wait(3); print(`----------------------------------------------------------loadk and more------------------------------------------------`)
-- LOADK: random tips constant
local K1 = 123456
local K2 = -98765
local K3 = 3.1415926
local K4 = "constant_string"
local K5 = true
local K6 = false
local K7 = nil

-- GETGLOBAL / SETGLOBAL in _ENV
local _ENV = _G or getfenv()
_ENV.GLOB_A = K1
_ENV.GLOB_B = K4


-- WRAP:

GLOB_A = K1
GLOB_B = K4

local function wrap(a)
	local C1 = a
	local C2 = 42
	local C3 = "wrap"

	return function(b)
		return C1 + b, C3 .. ":" .. tostring(C2), GLOB_A
	end
end


local f1 = wrap(10)
local r1, r2, r3 = f1(5)

--(SETGLOBAL)
GLOB_A = r1

-- WRAP + LOADK
local function outer(x)
	local K = x * 2
	return function(y)
		return function(z)
			return K + y + z
		end
	end
end

local deep = outer(3)(4)
local deep_res = deep(5)

-- GETGLOBAL
local t = {}
table.insert(t, r1)
table.insert(t, r3)
table.insert(t, deep_res)

-- LOADK + CONCAT + LEN
local s = K4 .. "_" .. tostring(#t)

print(
	r1,        -- 15
	r2,        -- "wrap:42"
	r3,        -- 123456
	GLOB_A,    -- 15
	deep_res,  -- 3*2 + 4 + 5 = 15
	s          -- "constant_string_3"
)


task.wait(2); print(`----------------------------------------------------------final test wvar and tails and more------------------------------------------------`)


-- VARARG + MULTRET + SETLIST B=0
local function multi(...)
	local t = {...}
	local n = select("#", ...)
	local out = {}
	for i = 1, n do
		out[i] = t[i]
	end
	return table.unpack(out, 1, n)
end

-- TAILCALL recurs
local function tail(n)
	if n <= 0 then return 0 end
	return tail(n-1) + 1
end

-- FORLOOP / FORPREP / TFORCALL / TFORLOOP
local function loops()
	local sum = 0
	for i = 1, 100, 2 do
		sum = sum + i
	end

	local tbl = {1,2,3,4,5,6,7,8,9,10}
	for k,v in pairs(tbl) do
		sum = sum + v
	end

	for i = 100, 1, -3 do
		sum = sum + i
	end

	return sum
end

-- TEST / TESTSET / JMP
local function testjmp(x)
	local res = 0
	if x % 2 == 0 then
		res = res + 2
	elseif x % 3 == 0 then
		res = res + 3
	else
		res = res + 1
	end

	local flag = false
	if res > 10 then
		flag = true
	end

	return res, flag
end

-- SETLIST B=0 (>50)
local function setliststress(...)
	local out = {}
	local n = select("#", ...)
	for i = 1, n do
		out[i] = select(i, ...)
	end
	return table.unpack(out, 1, n)
end

local function stress(...)
	local a1,a2,a3,a4,a5,a6,a7,a8,a9,a10
	a1,a2,a3,a4,a5,a6,a7,a8,a9,a10 = setliststress(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,
	21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,
	41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60)

	local rtail = tail(1000)
	local rloop = loops()
	local rtest, rflag = testjmp(rloop)

	local multiret1, multiret2, multiret3 = multi(5,10,15,20)

	return rtail, rloop, rtest, rflag, multiret1, multiret2, multiret3, a55, a60
end

local t = {stress()}
for i=1,#t do
	print(t[i])
end
print("")
print("")
print("")
print("")
print("")
print("done test")
